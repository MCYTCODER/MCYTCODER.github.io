<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VyXo Friends Chat</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#181818; color:#F1F1F1; }
header{ padding:15px; background:#00C4FF; font-weight:bold; text-align:center; }
#container{ display:flex; height:calc(100vh - 50px); }
#sidebar{ width:250px; background:#202020; padding:10px; overflow-y:auto; }
#chatContainer{ flex:1; display:flex; flex-direction:column; }
#chat{ flex:1; overflow-y:auto; padding:10px; }
#inputContainer{ display:flex; padding:10px; background:#202020; }
input,button{ padding:10px; margin:5px; border-radius:8px; border:none; }
input[type="text"]{ flex:1; }
.friendBtn{ margin:2px; background:#FF6D1F; color:#fff; cursor:pointer; }
</style>
</head>
<body>

<header>VyXo Friends Chat</header>
<div id="container">
  <div id="sidebar">
    <h3>Friends</h3>
    <div id="friendsList"></div>
    <h3>Requests</h3>
    <div id="requestsList"></div>
    <h3>Add Friend</h3>
    <input type="text" id="addFriendInput" placeholder="Username">
    <button id="addFriendBtn">Send Request</button>
  </div>
  <div id="chatContainer">
    <div id="chat"></div>
    <div id="inputContainer">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- User login ---
auth.signInAnonymously().catch(console.error);
let username = prompt("Enter your username:");

// --- Initialize user in DB ---
async function initUser(){
  const userDoc = await db.collection('users').doc(username).get();
  if(!userDoc.exists){
    await db.collection('users').doc(username).set({friends:[], requests:[]});
  }
}
initUser();

// --- Add friend request ---
document.getElementById('addFriendBtn').addEventListener('click', async ()=>{
  const friendName = document.getElementById('addFriendInput').value;
  if(!friendName || friendName===username) return alert("Invalid username");
  const friendDoc = await db.collection('users').doc(friendName).get();
  if(!friendDoc.exists) return alert("User does not exist");
  const requests = friendDoc.data().requests || [];
  if(requests.includes(username)) return alert("Request already sent");
  requests.push(username);
  await db.collection('users').doc(friendName).update({requests});
  alert("Friend request sent!");
});

// --- Display requests ---
const requestsList = document.getElementById('requestsList');
db.collection('users').doc(username).onSnapshot(doc=>{
  requestsList.innerHTML="";
  const requests = doc.data().requests || [];
  requests.forEach(r=>{
    const div = document.createElement('div');
    div.textContent=r;
    const acceptBtn=document.createElement('button');
    acceptBtn.textContent='Accept';
    acceptBtn.className='friendBtn';
    acceptBtn.onclick = async ()=>{
      // add each other as friends
      const userDoc = await db.collection('users').doc(username).get();
      let friends = userDoc.data().friends || [];
      friends.push(r);
      await db.collection('users').doc(username).update({friends, requests: requests.filter(x=>x!==r)});
      const friendDoc = await db.collection('users').doc(r).get();
      let friendFriends = friendDoc.data().friends || [];
      friendFriends.push(username);
      await db.collection('users').doc(r).update({friends: friendFriends});
      alert("Friend added!");
    }
    div.appendChild(acceptBtn);
    requestsList.appendChild(div);
  });
});

// --- Display friends ---
const friendsList = document.getElementById('friendsList');
let activeFriend = null;
db.collection('users').doc(username).onSnapshot(doc=>{
  friendsList.innerHTML="";
  const friends = doc.data().friends || [];
  friends.forEach(f=>{
    const div = document.createElement('div');
    div.textContent=f;
    div.className='friendBtn';
    div.onclick = ()=>{
      activeFriend=f;
      loadChat(f);
    };
    friendsList.appendChild(div);
  });
});

// --- Send message ---
const chatDiv = document.getElementById('chat');
document.getElementById('sendBtn').addEventListener('click', async ()=>{
  if(!activeFriend) return alert("Select a friend!");
  const text = document.getElementById('messageInput').value;
  if(!text) return;
  const chatId = [username, activeFriend].sort().join("_");
  await db.collection('messages').doc(chatId).collection('msgs').add({
    from: username,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('messageInput').value="";
});

// --- Load chat ---
function loadChat(friend){
  const chatId = [username, friend].sort().join("_");
  db.collection('messages').doc(chatId).collection('msgs')
    .orderBy('timestamp')
    .onSnapshot(snapshot=>{
      chatDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const msg=doc.data();
        const div=document.createElement('div');
        div.innerHTML=`<b>${msg.from}:</b> ${msg.text}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });
}
</script>
</body>
</html>
