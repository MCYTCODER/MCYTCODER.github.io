<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VyXo Social Chat</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#181818;color:#F1F1F1;}
header{padding:15px;background:#00C4FF;text-align:center;font-weight:bold;}
#container{display:flex;height:calc(100vh-50px);}
#sidebar{width:250px;background:#202020;padding:10px;overflow-y:auto;}
#chatContainer{flex:1;display:flex;flex-direction:column;}
#chat{flex:1;overflow-y:auto;padding:10px;}
#inputContainer{display:flex;padding:10px;background:#202020;}
input,button{padding:10px;margin:5px;border-radius:8px;border:none;}
input[type="text"]{flex:1;}
.friendBtn{margin:2px;background:#FF6D1F;color:#fff;cursor:pointer;}
#profile img{width:100px;height:100px;border-radius:50%;cursor:pointer;}
</style>
</head>
<body>

<header>VyXo Chat</header>

<div id="container">
  <div id="sidebar">
    <h3>Profile</h3>
    <div id="profile">
      <img id="profilePic" src="https://via.placeholder.com/100">
      <input type="text" id="displayName" placeholder="Display Name">
      <button id="saveProfile">Save</button>
      <p>Username: <span id="usernameDisplay"></span></p>
    </div>
    <h3>Friends</h3>
    <div id="friendsList"></div>
    <h3>Requests</h3>
    <div id="requestsList"></div>
    <h3>Add Friend</h3>
    <input type="text" id="addFriendInput" placeholder="Username">
    <button id="addFriendBtn">Send Request</button>
  </div>
  <div id="chatContainer">
    <div id="chat"></div>
    <div id="inputContainer">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
      <button id="imgBtn">ðŸ“·</button>
      <button id="voiceBtn">ðŸŽ¤</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-storage-compat.js"></script>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// --- User login ---
auth.signInAnonymously().catch(console.error);

// --- Random unique username ---
function generateUsername(){return "VyXo_"+Math.floor(Math.random()*100000);}
let username = localStorage.getItem('vyxoUsername');
if(!username){
  username = generateUsername();
  localStorage.setItem('vyxoUsername', username);
  db.collection('users').doc(username).set({
    displayName:"Chahi",
    profilePic:"",
    friends:[],
    requests:[]
  });
}

// --- Profile setup ---
const profilePic = document.getElementById('profilePic');
const displayName = document.getElementById('displayName');
const usernameDisplay = document.getElementById('usernameDisplay');
usernameDisplay.textContent = username;

// Load profile
db.collection('users').doc(username).get().then(doc=>{
  if(doc.exists){
    const data = doc.data();
    displayName.value = data.displayName || "Chahi";
    if(data.profilePic) profilePic.src = data.profilePic;
  }
});

// Change profile pic
profilePic.addEventListener('click',()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.click();
  input.onchange = async ()=>{
    const file = input.files[0];
    const ref = storage.ref('profiles/'+username+'/'+file.name);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    profilePic.src = url;
    await db.collection('users').doc(username).update({profilePic:url});
  };
});

// Save display name
document.getElementById('saveProfile').addEventListener('click',()=>{
  db.collection('users').doc(username).update({displayName: displayName.value});
});

// --- Add friend request ---
document.getElementById('addFriendBtn').addEventListener('click', async ()=>{
  const friendName = document.getElementById('addFriendInput').value;
  if(!friendName || friendName===username) return alert("Invalid username");
  const friendDoc = await db.collection('users').doc(friendName).get();
  if(!friendDoc.exists) return alert("User does not exist");
  let requests = friendDoc.data().requests || [];
  if(requests.find(r=>r.name===username)) return alert("Request already sent");
  requests.push({name:username, unread:true});
  await db.collection('users').doc(friendName).update({requests});
  alert("Friend request sent!");
});

// --- Render requests with red dot and accept ---
const requestsList = document.getElementById('requestsList');
function renderRequests(requests){
  requestsList.innerHTML="";
  requests.forEach(req=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = req.name;
    if(req.unread){
      const redDot = document.createElement('span');
      redDot.style.width='10px'; redDot.style.height='10px';
      redDot.style.background='red'; redDot.style.borderRadius='50%';
      redDot.style.display='inline-block'; redDot.style.marginRight='5px';
      nameSpan.prepend(redDot);
    }
    div.appendChild(nameSpan);

    const acceptBtn = document.createElement('button');
    acceptBtn.textContent='Accept'; acceptBtn.className='friendBtn';
    acceptBtn.addEventListener('click', async ()=>{
      const userRef = db.collection('users').doc(username);
      const friendRef = db.collection('users').doc(req.name);
      await db.runTransaction(async t=>{
        const userDoc = await t.get(userRef);
        const friendDoc = await t.get(friendRef);

        let userFriends = userDoc.data().friends || [];
        let friendFriends = friendDoc.data().friends || [];

        if(!userFriends.includes(req.name)) userFriends.push(req.name);
        if(!friendFriends.includes(username)) friendFriends.push(username);

        // Remove request
        const updatedRequests = (userDoc.data().requests || []).filter(r=>r.name!==req.name);
        t.update(userRef, {friends:userFriends, requests:updatedRequests});
        t.update(friendRef, {friends:friendFriends});
      });
    });
    div.appendChild(acceptBtn);
    requestsList.appendChild(div);
  });
}

// Real-time requests update
db.collection('users').doc(username).onSnapshot(doc=>{
  const data = doc.data();
  renderRequests(data.requests || []);
});

// --- Friends list ---
const friendsList = document.getElementById('friendsList');
let activeFriend=null;
db.collection('users').doc(username).onSnapshot(doc=>{
  friendsList.innerHTML="";
  const friends = doc.data().friends || [];
  friends.forEach(f=>{
    const div = document.createElement('div');
    div.textContent=f; div.className='friendBtn';
    div.onclick = ()=>{ activeFriend=f; loadChat(f); };
    friendsList.appendChild(div);
  });
});

// --- Chat ---
const chatDiv = document.getElementById('chat');
document.getElementById('sendBtn').addEventListener('click', async ()=>{
  if(!activeFriend) return alert("Select a friend!");
  const text = document.getElementById('messageInput').value;
  if(!text) return;
  const chatId = [username, activeFriend].sort().join("_");
  await db.collection('messages').doc(chatId).collection('msgs').add({
    from:username, text, type:'text', timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('messageInput').value="";
});

// --- Load chat ---
function loadChat(friend){
  const chatId=[username,friend].sort().join("_");
  db.collection('messages').doc(chatId).collection('msgs')
    .orderBy('timestamp')
    .onSnapshot(snapshot=>{
      chatDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const msg=doc.data();
        const div=document.createElement('div');
        div.innerHTML=`<b>${msg.from}:</b> ${msg.text}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });
}

// --- Image upload ---
document.getElementById('imgBtn').addEventListener('click', async ()=>{
  if(!activeFriend) return alert("Select a friend!");
  const fileInput = document.createElement('input');
  fileInput.type='file'; fileInput.accept='image/*'; fileInput.click();
  fileInput.onchange=async ()=>{
    const file=fileInput.files[0];
    const ref = storage.ref('chatImages/'+Date.now()+file.name);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    const chatId=[username,activeFriend].sort().join("_");
    await db.collection('messages').doc(chatId).collection('msgs').add({
      from:username, image:url, type:'image', timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  };
});

// --- Voice messages ---
let mediaRecorder, audioChunks=[];
document.getElementById('voiceBtn').addEventListener('mousedown', async ()=>{
  if(!activeFriend) return alert("Select a friend!");
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder = new MediaRecorder(stream);
  audioChunks=[];
  mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
  mediaRecorder.start();
});
document.getElementById('voiceBtn').addEventListener('mouseup', async ()=>{
  mediaRecorder.stop();
  mediaRecorder.onstop=async ()=>{
    const blob=new Blob(audioChunks,{type:'audio/webm'});
    const ref = storage.ref('chatVoice/'+Date.now()+'.webm');
    await ref.put(blob);
    const url = await ref.getDownloadURL();
    const chatId=[username,activeFriend].sort().join("_");
    await db.collection('messages').doc(chatId).collection('msgs').add({
      from:username, voice:url, type:'voice', timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  };
});
</script>
</body>
</html>
